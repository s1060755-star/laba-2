<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velvet Bite — Замовлення</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alegreya:ital,wght@0,400..900;1,400..900&family=Beau+Rivage&family=Montserrat:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Навігація -->
    <header>
        <nav class="navbar">
            <div class="left-group">
                <div class="menu-toggle" id="menu-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <h1 class="logo"><span>Velvet</span> Bite</h1>
            </div>

            <h2 class="navigation">Оформлення замовлення</h2>

        <!-- Футер -->
            <ul class="nav-links" id="nav-links">
                <li><a href="/#home">Головна</a></li>
                <li><a href="/#menu">Меню</a></li>
                <li><a href="/favourite">Улюблені страви</a></li>
                <li><a href="/#contact">Зв'язок</a></li>
                <li><a href="/about">Про нас</a></li>
                <li><a href="/service">Наші послуги</a></li>
                <li><a href="/locate">Наші локації</a></li>
                <li><a href="/work">Приєднуйтеся до нас</a></li>
                <li class="navbar-account">
                    {% if session.get('user_id') %}
                    <a href="{{ url_for('account') }}" class="account-btn">
                        <img src="/static/images/avatar.jpg" alt="Аватар користувача" class="avatar">
                        <span class="account-text">Мій профіль</span>
                    </a>
                    {% else %}
                    <a href="{{ url_for('signUp') }}" class="account-btn">
                        <img src="/static/images/avatar.jpg" alt="Аватар користувача" class="avatar">
                        <span class="account-text">Мій профіль</span>
                    </a>
                    {% endif %}
                </li>
            </ul>
        </nav>
    </header>

    <main style="max-width:900px;margin:24px auto">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, msg in messages %}
                            <div class="flash-{{ category }}">{{ msg }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <section style="display:grid;grid-template-columns:1fr 350px;gap:20px">
                <div>
                    <h2>Оформити замовлення</h2>
                    <form method="post" action="{{ url_for('create_order') }}" style="display:flex;flex-direction:column;gap:10px" id="orderForm">
                        <label>Ім'я</label>
                        <input type="text" name="name" placeholder="Ваше ім'я" value="{{ account['first_name'] if account and 'first_name' in account.keys() else '' }}">
                        <label>Телефон</label>
                        <input type="text" name="phone" placeholder="Телефон" value="{{ account['phone'] if account and 'phone' in account.keys() else '' }}">
                            <label>Номер столу</label>
                            <input type="text" name="address" placeholder="Номер столу (для dine-in)" value="{{ request.args.get('table') or '' }}" required>

                        <label>Додати страву</label>
                        <div style="display:flex;gap:8px;align-items:center">
                            <select id="dishSelect" style="flex:1">
                                <option value="">-- Оберіть страву --</option>
                                {% for d in dishes %}
                                    <option value="{{ d['id'] }}" data-price="{{ d['price'] }}">{{ d['name'] }} — {{ d['price']|int }} грн</option>
                                {% endfor %}
                            </select>
                            <input type="number" id="dishQty" min="1" value="1" style="width:80px">
                            <button type="button" id="addDishBtn" class="btn">Додати</button>
                        </div>

                        <label>Список товарів</label>
                        <div id="itemsList" style="min-height:40px;padding:8px;border:1px solid #eee;border-radius:6px;background:#fff">
                            <!-- items will be rendered here -->
                        </div>
                        <input type="hidden" name="items" id="itemsInput" value="[]">
                        <input type="hidden" name="discount" id="discountInput" value="0">
                        <div id="discountInfo" style="margin-top:6px;color:#4B2E2B;font-weight:700"></div>
                        <!-- discount debug UI removed per request -->
                        <div style="margin-top:8px">Загальна сума: <strong id="total">0</strong> грн</div>

                        <button class="btn" type="submit">Надіслати замовлення</button>
                    </form>
                </div>
                <aside>
                    <h3>Мої попередні замовлення</h3>
                    {% if orders and orders|length > 0 %}
                        <ul>
                            {% for o in orders %}
                                    <li style="margin-bottom:12px">
                                    <strong>#{{ o.id }}</strong> — {{ o.items_text if o.items_text is defined else o.items }} — {{ o.total|int }} грн — {{ o.status or 'new' }}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Ви ще не робили замовлень.</p>
                    {% endif %}
                </aside>
            </section>
    </main>

        <!-- Футер -->
    <footer>
        <p>© 2025 Velvet Bite. Всі права захищені.</p>
    </footer>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function(){
            try{

            const dishSelect = document.getElementById('dishSelect');
            const dishes = {};
            for (let i=0;i<dishSelect.options.length;i++){
                const opt = dishSelect.options[i];
                const val = opt.value;
                if (!val) continue;
                const id = parseInt(val);
                let price = parseFloat(opt.getAttribute('data-price') || '0');
                if (isNaN(price)){
                    const m = opt.textContent.match(/([0-9]+(?:[.,][0-9]+)?)/);
                    if (m) price = parseFloat(m[1].replace(',', '.')) || 0;
                    else price = 0;
                }

                const name = opt.textContent.replace(/\s*—.*$/, '').trim();
                dishes[id] = {id: id, name: name, price: price};
            }
            const dishQty = document.getElementById('dishQty');
            const addBtn = document.getElementById('addDishBtn');
            const itemsList = document.getElementById('itemsList');
            const itemsInput = document.getElementById('itemsInput');
            const totalEl = document.getElementById('total');

            let items = [];

            function renderItems(){
                itemsList.innerHTML = '';
                let total = 0;
                items.forEach((it, idx) => {
                    const d = dishes[it.dish_id];
                    const name = d ? d.name : ('#' + it.dish_id);
                    const price = d ? parseFloat(d.price) : 0;
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.alignItems = 'center';
                    row.style.padding = '6px 0';
                    row.innerHTML = `<div>${name} — ${Math.round(price)} грн × <input type="number" value="${it.qty}" min="1" style="width:60px" data-idx="${idx}" class="qtyInput"></div><div><strong>${Math.round(price * it.qty)}</strong> грн <button data-idx="${idx}" class="removeBtn" style="margin-left:8px">✕</button></div>`;
                    itemsList.appendChild(row);
                });
                items.forEach(it => {
                    const price = (dishes[it.dish_id] ? parseFloat(dishes[it.dish_id].price) : 0);
                    total += price * it.qty;
                });
                itemsInput.value = JSON.stringify(items);
                // apply any active discount stored in localStorage (robust parse)
                let discount = 0;
                try{
                    const raw = localStorage.getItem('activeDiscount') || '0';
                    const m = String(raw).match(/-?\d+(?:\.\d+)?/);
                    discount = m ? parseFloat(m[0]) : 0;
                }catch(e){ discount = 0 }
                const totalRounded = Math.round(total);
                if(discount && discount > 0){
                    const discounted = Math.round((total * (1 - discount/100)) * 100)/100;
                    totalEl.textContent = discounted;
                    const infoEl = document.getElementById('discountInfo');
                    const discInput = document.getElementById('discountInput');
                    if(infoEl) infoEl.textContent = `Знижка ${discount}% застосована — початкова сума ${totalRounded} грн, платіж: ${discounted} грн`;
                    if(discInput) discInput.value = String(discount);
                } else {
                    totalEl.textContent = totalRounded;
                    const infoEl = document.getElementById('discountInfo'); if(infoEl) infoEl.textContent = '';
                    const discInput = document.getElementById('discountInput'); if(discInput) discInput.value = '0';
                }

                // update debug UI and ensure discount input is synced
                try{ if(typeof applyDiscountUI === 'function') applyDiscountUI(); }catch(e){}

                // attach handlers
                itemsList.querySelectorAll('.removeBtn').forEach(btn => btn.addEventListener('click', function(){
                    const idx = parseInt(this.getAttribute('data-idx'));
                    items.splice(idx,1);
                    renderItems();
                }));
                itemsList.querySelectorAll('.qtyInput').forEach(inp => inp.addEventListener('change', function(){
                    const idx = parseInt(this.getAttribute('data-idx'));
                    const v = parseInt(this.value) || 1;
                    items[idx].qty = v;
                    renderItems();
                }));
            }

            // expose for external refresh (global script may call window.renderItems())
            try{ window.renderItems = renderItems; }catch(e){}

            addBtn.addEventListener('click', function(){
                const did = parseInt(dishSelect.value);
                const qty = parseInt(dishQty.value) || 1;
                if (!did) return;

                const existing = items.find(it => it.dish_id === did);
                if (existing) {
                    existing.qty += qty;
                } else {
                    items.push({dish_id: did, qty: qty});
                }
                renderItems();
                try{ if(typeof applyDiscountUI === 'function') applyDiscountUI(); }catch(e){}
            });

            // apply discount UI helper: reads localStorage and updates debug, discountInput and discountInfo
            function applyDiscountUI(){
                try{
                    const raw = localStorage.getItem('activeDiscount') || '0';
                    const m = String(raw).match(/-?\d+(?:\.\d+)?/);
                    const disc = m ? parseFloat(m[0]) : 0;
                    const cur = document.getElementById('discountCurrent');
                    const discInput = document.getElementById('discountInput');
                    const infoEl = document.getElementById('discountInfo');
                    if(cur) cur.textContent = `Поточна знижка: ${disc > 0 ? disc + '%' : '—'}`;
                    if(discInput) discInput.value = String(disc > 0 ? disc : 0);
                    if(infoEl && disc > 0){
                        // keep existing info text if renderItems already set it, otherwise set minimal text
                        if(!infoEl.textContent || infoEl.textContent.indexOf('застосована') === -1) infoEl.textContent = `Знижка ${disc}% застосована`;
                    }
                }catch(e){ }
            }

                // wire apply button for manual testing
            try{
                const applyBtn = document.getElementById('applyDiscountBtn');
                if(applyBtn) applyBtn.addEventListener('click', function(){
                    try{ applyDiscountUI(); renderItems(); }catch(e){}
                });
            }catch(e){}

            }catch(e){}

        });

                // Додаємо попередньо вибрану страву, якщо є
    </script>
    <!-- Inject preselected dish data via data attributes to avoid JS parser errors in editors -->
    <div id="preData" style="display:none"
         data-pre-dish='{{ pre_dish|tojson }}'
         data-pre-qty='{{ pre_qty|tojson }}'></div>
    <script>
    // Read preselected dish after DOM ready and push to items if available
    document.addEventListener('DOMContentLoaded', function() {
        try {
            var preEl = document.getElementById('preData');
            if (!preEl) return;
            var rawDish = preEl.getAttribute('data-pre-dish');
            var rawQty = preEl.getAttribute('data-pre-qty');
            var pd = null, pq = null;
            try { pd = JSON.parse(rawDish); } catch(e) { pd = null; }
            try { pq = JSON.parse(rawQty); } catch(e) { pq = null; }
            if (pd != null && typeof window.items !== 'undefined') {
                var qty = (typeof pq === 'number' ? pq : (parseInt(pq) || 1));
                window.items.push({dish_id: pd, qty: qty});
                if (typeof window.renderItems === 'function') window.renderItems();
            }
        } catch(e) { }
    });
    </script>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                renderItems();
            } catch(err) {
                console.error('Order page script error:', err);
            }
        });
        </script>
</body>
</html>